<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function() {  /* widget controller */  var c = this;};]]></client_script>
        <controller_as>c</controller_as>
        <css>// FlightOps 360 Booking Status Widget Styles&#13;
.booking-status-panel {&#13;
  margin: 20px 0;&#13;
  &#13;
  .fa-plane {&#13;
    margin-right: 5px;&#13;
  }&#13;
  &#13;
  .table &gt; tbody &gt; tr:hover {&#13;
    background-color: #f5f5f5;&#13;
    cursor: pointer;&#13;
  }&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description>Displays customer booking status</description>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>booking_status</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Booking Status Widget</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[/**
 * FlightOps 360 - Booking Status Widget
 * Server-side data controller
 * Purpose: Fetch and format customer booking data
 */
(function() {
  
  // Initialize data object
  data.bookings = [];
  data.loading = false;
  data.last_updated = new GlideDateTime().getDisplayValue();
  data.showRecommendation = false;
  data.latestRecommendation = '';
  data.catalog_item_id = '';
  
  // Get currently logged-in user
  var currentUserId = gs.getUserID();
  
  // Security check: Only show data if user is logged in
  if (!currentUserId) {
    gs.addErrorMessage('Please log in to view your bookings');
    return;
  }
  
  try {
    
    // ====================================================================
    // STEP 1: Query ticket bookings for the current user
    // ====================================================================
    var bookingGR = new GlideRecord('x_1603912_flightop_ticket_booking');
    bookingGR.addQuery('customer_id', currentUserId);
    bookingGR.orderByDesc('sys_created_on'); // Most recent first
    bookingGR.setLimit(50); // Limit to 50 records for performance
    bookingGR.query();
    
    // ====================================================================
    // STEP 2: Process each booking record
    // ====================================================================
    while (bookingGR.next()) {
      
      // Create booking object with formatted data
      var booking = {
        sys_id: bookingGR.getValue('sys_id'),
        number: bookingGR.getDisplayValue('number'),
        flight_number: bookingGR.getValue('flight_number'),
        seat_selection: bookingGR.getValue('seat_selection'),
        flight_price: bookingGR.getValue('flight_price'),
        booking_status: bookingGR.getValue('booking_status'),
        booking_status_display: bookingGR.getDisplayValue('booking_status'),
        created_on: bookingGR.sys_created_on.getDisplayValue(),
        genai_recommendation: bookingGR.getValue('genai_recommendation')
      };
      
      // Add to bookings array
      data.bookings.push(booking);
      
      // Show recommendation from most recent booking
      if (data.bookings.length === 1 && booking.genai_recommendation) {
        data.showRecommendation = true;
        data.latestRecommendation = booking.genai_recommendation;
      }
    }
    
    // ====================================================================
    // STEP 3: Get the Book a Flight catalog item ID for the "Book Now" button
    // ====================================================================
    var catalogItemGR = new GlideRecord('sc_cat_item');
    catalogItemGR.addQuery('name', 'Book a Flight');
    catalogItemGR.setLimit(1);
    catalogItemGR.query();
    
    if (catalogItemGR.next()) {
      data.catalog_item_id = catalogItemGR.getValue('sys_id');
    }
    
    // ====================================================================
    // STEP 4: Log for debugging (optional - remove in production)
    // ====================================================================
    gs.info('FlightOps 360: Loaded ' + data.bookings.length + ' bookings for user ' + currentUserId);
    
  } catch (error) {
    // Error handling
    gs.error('FlightOps 360 Widget Error: ' + error.message);
    gs.addErrorMessage('Unable to load booking data. Please try again.');
  }
  
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-11-17 20:29:34</sys_created_on>
        <sys_id>390424d9c355f610a9babe1d0501316f</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Booking Status Widget</sys_name>
        <sys_package display_value="FlightOps 360" source="x_1603912_flightop">9268dd89c35d7610a9babe1d0501314f</sys_package>
        <sys_policy/>
        <sys_scope display_value="FlightOps 360">9268dd89c35d7610a9babe1d0501314f</sys_scope>
        <sys_update_name>sp_widget_390424d9c355f610a9babe1d0501316f</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-11-17 20:29:34</sys_updated_on>
        <template><![CDATA[<!-- 
  FlightOps 360 - Booking Status Widget
  Displays customer's flight bookings with status
-->
<div class="panel panel-default booking-status-panel">
  <!-- Panel Header -->
  <div class="panel-heading" style="background-color: #003366; color: white;">
    <h3 class="panel-title">
      <i class="fa fa-plane"></i> My Flight Bookings
    </h3>
  </div>
  
  <!-- Panel Body -->
  <div class="panel-body">
    
    <!-- Loading Indicator -->
    <div ng-if="c.data.loading" class="text-center">
      <i class="fa fa-spinner fa-spin fa-3x"></i>
      <p>Loading your bookings...</p>
    </div>
    
    <!-- Bookings Table -->
    <div ng-if="!c.data.loading && c.data.bookings.length > 0">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Booking Number</th>
            <th>Flight Number</th>
            <th>Seat</th>
            <th>Price</th>
            <th>Status</th>
            <th>Booked On</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="booking in c.data.bookings">
            <td>
              <strong>{{booking.number}}</strong>
            </td>
            <td>
              <i class="fa fa-plane"></i> {{booking.flight_number}}
            </td>
            <td>
              {{booking.seat_selection || 'Not assigned'}}
            </td>
            <td>
              <span style="color: green; font-weight: bold;">
                ${{booking.flight_price}}
              </span>
            </td>
            <td>
              <span class="label" ng-class="{
                'label-info': booking.booking_status === 'new',
                'label-success': booking.booking_status === 'confirmed',
                'label-warning': booking.booking_status === 'cancelled',
                'label-danger': booking.booking_status === 'refunded'
              }">
                {{booking.booking_status_display}}
              </span>
            </td>
            <td>
              {{booking.created_on}}
            </td>
            <td>
              <button class="btn btn-sm btn-primary" 
                      ng-click="c.viewDetails(booking.sys_id)">
                View Details
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <!-- AI Recommendation Display -->
      <div ng-if="c.data.showRecommendation" class="alert alert-info" style="margin-top: 20px;">
        <h4><i class="fa fa-lightbulb-o"></i> Personalized Recommendation</h4>
        <p>{{c.data.latestRecommendation}}</p>
      </div>
    </div>
    
    <!-- No Bookings Message -->
    <div ng-if="!c.data.loading && c.data.bookings.length === 0" class="text-center">
      <i class="fa fa-ticket fa-5x" style="color: #ccc;"></i>
      <h4>No bookings found</h4>
      <p>You haven't made any flight bookings yet.</p>
      <a href="?id=sc_cat_item&sys_id={{c.data.catalog_item_id}}" class="btn btn-primary">
        <i class="fa fa-plus"></i> Book a Flight Now
      </a>
    </div>
    
  </div>
  
  <!-- Panel Footer -->
  <div class="panel-footer text-right">
    <small>Last updated: {{c.data.last_updated}}</small>
  </div>
</div>

<!-- Custom CSS -->
<style>
  .booking-status-panel {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  
  .booking-status-panel .table {
    margin-bottom: 0;
  }
  
  .booking-status-panel .panel-heading {
    border-bottom: 3px solid #002244;
  }
  
  .booking-status-panel .label {
    font-size: 12px;
    padding: 5px 10px;
  }
</style>]]></template>
    </sp_widget>
</record_update>
