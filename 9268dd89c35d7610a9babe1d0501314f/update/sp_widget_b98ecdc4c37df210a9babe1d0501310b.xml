<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function FlightOpsLoyaltyInsightController() {
  var c = this;
  // Additional interactions (e.g., refresh) can be added later
}]]></client_script>
        <controller_as>c</controller_as>
        <css>$primary: #494cbb;&#13;
$accent: #ffa201;&#13;
&#13;
.flightops-loyalty-card {&#13;
  background: var(--flightops-panel);&#13;
  border: 1px solid var(--flightops-border);&#13;
  border-radius: 18px;&#13;
  padding: 24px;&#13;
  box-shadow: 0 12px 32px rgba(73, 76, 187, 0.12);&#13;
&#13;
  &amp;.empty {&#13;
    text-align: center;&#13;
    h3 { color: $primary; }&#13;
    .btn-primary {&#13;
      margin-top: 12px;&#13;
      display: inline-flex;&#13;
      align-items: center;&#13;
      gap: 8px;&#13;
      background: $primary;&#13;
      color: #fff;&#13;
      padding: 12px 24px;&#13;
      border-radius: 999px;&#13;
      text-decoration: none;&#13;
    }&#13;
  }&#13;
&#13;
  .loyalty-card__header {&#13;
    display: flex;&#13;
    justify-content: space-between;&#13;
    align-items: center;&#13;
&#13;
    .eyebrow {&#13;
      text-transform: uppercase;&#13;
      font-size: 11px;&#13;
      letter-spacing: 1px;&#13;
      color: var(--flightops-muted);&#13;
    }&#13;
&#13;
    h3 {&#13;
      margin: 6px 0 0;&#13;
      font-size: 24px;&#13;
      color: $primary;&#13;
    }&#13;
&#13;
    .tier-chip {&#13;
      padding: 6px 14px;&#13;
      border-radius: 999px;&#13;
      font-weight: 600;&#13;
      &amp;.tier-gold { background: rgba(255, 210, 130, 0.25); color: #c48f00; }&#13;
      &amp;.tier-platinum { background: rgba(73, 76, 187, 0.2); color: $primary; }&#13;
      &amp;.tier-silver { background: rgba(139, 140, 207, 0.2); color: var(--flightops-muted); }&#13;
      &amp;.tier-bronze { background: rgba(255, 162, 1, 0.2); color: $accent; }&#13;
    }&#13;
  }&#13;
&#13;
  .loyalty-card__body {&#13;
    display: flex;&#13;
    gap: 24px;&#13;
    margin: 24px 0;&#13;
    .stat {&#13;
      flex: 1;&#13;
      .stat-label { color: var(--flightops-muted); margin-bottom: 4px; }&#13;
      h2 { margin: 0; font-size: 32px; color: $primary; }&#13;
      .stat-value { font-size: 18px; font-weight: 600; color: #222; }&#13;
    }&#13;
  }&#13;
&#13;
  .progress-block {&#13;
    margin-bottom: 18px;&#13;
    .progress-top {&#13;
      display: flex;&#13;
      justify-content: space-between;&#13;
      color: var(--flightops-muted);&#13;
      margin-bottom: 6px;&#13;
    }&#13;
    .progress-bar {&#13;
      width: 100%;&#13;
      height: 10px;&#13;
      border-radius: 999px;&#13;
      background: #ebeaf6;&#13;
      .progress-fill {&#13;
        height: 100%;&#13;
        border-radius: inherit;&#13;
        background: linear-gradient(90deg, $accent, lighten($accent, 10%));&#13;
      }&#13;
    }&#13;
  }&#13;
&#13;
  .loyalty-card__recommendation {&#13;
    display: flex;&#13;
    gap: 10px;&#13;
    align-items: flex-start;&#13;
    background: rgba(73, 76, 187, 0.08);&#13;
    padding: 12px;&#13;
    border-radius: 12px;&#13;
    color: #2c2f6d;&#13;
    i { color: $primary; }&#13;
  }&#13;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description>Shows loyalty tier, trip progress, and next-tier tips</description>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>flightops_loyalty_insight</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>FlightOps Loyalty Insight</name>
        <option_schema/>
        <public>false</public>
        <roles>x_1603912_flightop.customer,x_1603912_flightop.ops_manager</roles>
        <script><![CDATA[(function() {
  data.loading = true;
  data.hasProfile = false;

  var userId = gs.getUserID();
  if (!userId) {
    gs.addErrorMessage('Please log in to view loyalty insights.');
    data.loading = false;
    return;
  }

  var profileGR = new GlideRecord('x_1603912_flightop_customer_profile');
  profileGR.addQuery('u_customer', userId);
  profileGR.setLimit(1);
  profileGR.query();

  if (profileGR.next()) {
    data.hasProfile = true;
    data.profile = {
      loyalty_status: profileGR.getValue('u_loyalty_status'),
      historical_trips: parseInt(profileGR.getValue('u_historical_trips'), 10) || 0,
      preferred_upgrade_type: profileGR.getValue('u_preferred_upgrade_type')
    };

    var insights = new FlightOpsGeminiIntegration().getCustomerInsights(userId);
    data.tierLabel = insights.loyaltyTier || 'Member';
    data.nextTierName = insights.nextTierName;
    data.progressPercent = Math.min(100, insights.nextTierProgress || 0);
    data.tip = insights.recommendations && insights.recommendations.length ?
      insights.recommendations[0] :
      'Fly more to unlock exclusive perks!';
  }

  data.loading = false;
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-12-08 22:36:57</sys_created_on>
        <sys_id>b98ecdc4c37df210a9babe1d0501310b</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>FlightOps Loyalty Insight</sys_name>
        <sys_package display_value="FlightOps 360" source="x_1603912_flightop">9268dd89c35d7610a9babe1d0501314f</sys_package>
        <sys_policy/>
        <sys_scope display_value="FlightOps 360">9268dd89c35d7610a9babe1d0501314f</sys_scope>
        <sys_update_name>sp_widget_b98ecdc4c37df210a9babe1d0501310b</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-08 22:36:57</sys_updated_on>
        <template><![CDATA[<div class="flightops-loyalty-card" ng-if="c.data.hasProfile">
  <div class="loyalty-card__header">
    <div>
      <p class="eyebrow">Loyalty Tier</p>
      <h3>{{c.data.tierLabel}}</h3>
    </div>
    <span class="tier-chip tier-{{c.data.profile.loyalty_status}}">
      {{c.data.profile.loyalty_status | uppercase}}
    </span>
  </div>

  <div class="loyalty-card__body">
    <div class="stat">
      <p class="stat-label">Historical Trips</p>
      <h2>{{c.data.profile.historical_trips}}</h2>
    </div>
    <div class="stat">
      <p class="stat-label">Preferred Upgrade</p>
      <p class="stat-value">{{c.data.profile.preferred_upgrade_type || 'Not set'}}</p>
    </div>
  </div>

  <div class="progress-block" ng-if="c.data.nextTierName">
    <div class="progress-top">
      <span>Progress to {{c.data.nextTierName}}</span>
      <span>{{c.data.progressPercent}}%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" ng-style="{'width': c.data.progressPercent + '%'}"></div>
    </div>
  </div>

  <div class="loyalty-card__recommendation">
    <i class="fa fa-sparkles"></i>
    <p>{{c.data.tip}}</p>
  </div>
</div>

<div class="flightops-loyalty-card empty" ng-if="!c.data.loading && !c.data.hasProfile">
  <h3>Complete your profile</h3>
  <p>Add your preferences to unlock AI-powered upgrades.</p>
  <a class="btn-primary" href="/nav_to.do?uri=x_1603912_flightop_customer_profile.do?sys_id=-1">Create Profile</a>
</div>]]></template>
    </sp_widget>
</record_update>
